## Конвертация между XLSX и YAML

### `xlsx_to_yaml.py`
Скрипт преобразует табличные выгрузки SEAF в набор YAML‑файлов, поддерживая очистку данных, автогенерацию связей и базовую валидацию.

#### Основной процесс
1. **Чтение источников.** Путь к конфигу передаётся через `--config config_x2y.yaml`. В файле описаны:
   - `xlsx_files` — список входных книг;
   - `out_yaml_dir` — директория для результата.
2. **Нормализация значений.** Текст очищается от перевода строк и лишних пробелов, числовые поля приводятся к числам, списки разбиваются по `,`, `;`, табуляциям.
3. **Формирование YAML.** Для каждой сущности создаются отдельные файлы (`dc.yaml`, `network_segment.yaml`, `networks_<token>.yaml`, `components_network.yaml`, `kb.yaml` и т.д.), а `root.yaml` содержит список импортов.
4. **Валидация.**
   - Ссылки `AZ → Region`, `DC → AZ`, `Network → Segment`, `Device → Network` и др. проверяются в `validate_refs`.
   - `validate_enums` контролирует допустимые значения перечислений.
   - Любые несоответствия подсвечиваются через `WARN`/`ERROR` в отчёте, но выполнение не прерывается.

#### Особенности обработки сетевых устройств
- **Парсинг расположений.** Колонка `Расположение` может содержать одно значение или список площадок. После парсинга в объект попадает либо строка, либо список идентификаторов (`sbs.dc.01`, `sbs.office.msk-hq`, ...).
- **Автоопределение сегмента.**
  - Если в XLSX заполнено поле `Сетевой сегмент/зона (ID)`, оно переносится без изменений.
  - В противном случае скрипт собирает все сети из `Подключённые сети`, находит их сегменты и выбирает те, у которых `sber.location` совпадает с текущей площадкой устройства. Найденные значения подставляются автоматически, а в stdout выводится строка `INFO: Device <ID> assigned segment(s) [...] based on networks for location <LOCATION>.`
- **Разделение по площадкам.** Когда устройство привязано к нескольким площадкам, создаются индивидуальные копии (`<исходный ID>-03`, `<исходный ID>-05`, …). Для каждой копии вычисляется собственный сегмент, и в логе появляются сообщения `INFO: Device <ID> has multiple locations [...]` и `INFO: Created device <ID>-<SUFFIX> for location ...`.
- **Контроль отсутствующих сетей.** Если устройство ссылается на сеть, которой нет в выгруженных данных, идентификатор фиксируется. После обработки всех устройств выводится агрегированное предупреждение `WARN: Networks referenced by devices but missing in network data: ...`. Это помогает быстро обнаружить пропущенные WAN/EXT сети в исходной таблице.

#### Выходные данные и отчёт
- После конвертации печатаются сводки `--- Source XLSX Analysis ---`, `--- Destination YAML Analysis ---` и `--- Conversion Summary ---` с числом сущностей до/после и пометкой `OK/FAIL`.
- При генерации новых сегментов из многоадресных сетей выводится `INFO: Auto-created <N> new network segments.`
- Все предупреждения об отсутствующих ссылках, дубликатах и пропущенных сетях отображаются в stdout и логируются в `debug_script.log` (если включено).

### `yaml_to_xlsx.py`
Обратная утилита восстанавливает XLSX‑книги из YAML‑набора.
- Конфиг `config_y2x.yaml` содержит `yaml_dir` (откуда читать YAML) и `out_xlsx_dir` (куда записывать книги).
- Скрипт собирает сущности из `root.yaml` и сопровождающих файлов и раскладывает их по соответствующим листам (`Сегменты`, `Сети`, `Сетевые устройства`, ...).
- На выходе снова печатается сводка с количеством записей в каждом разделе, что позволяет сравнить данные «до» и «после» конвертации.

### Проверка «туда‑обратно»
Для интеграционного контроля предусмотрен сценарий `run_tests.py`:
1. Конвертирует YAML → XLSX.
2. Обратно XLSX → YAML.
3. Сравнивает итоговые файлы с исходными.
4. Выводит статус `STATUS: PASSED/FAILED` и список расхождений.

Эти процедуры позволяют обеспечить воспроизводимость данных и быстро находить расхождения между табличными шаблонами и YAML‑представлением.***
